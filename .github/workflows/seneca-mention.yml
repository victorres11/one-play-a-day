# .github/workflows/seneca-mention.yml
# Copy this to any repo to enable @seneca mentions on PRs
#
# Required secrets:
#   TELEGRAM_BOT_TOKEN: Clawdbot Telegram bot token
#   TELEGRAM_CHAT_ID: Victor's Telegram chat ID (8526033276)
#
name: Seneca PR Mention

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  notify-seneca:
    # Only run if comment contains @seneca (case insensitive)
    if: |
      github.event.comment &&
      contains(github.event.comment.body, '@seneca') ||
      contains(github.event.comment.body, 'seneca:') ||
      contains(github.event.comment.body, 'Seneca:')
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract context
        id: context
        run: |
          # Determine if it's a PR comment or review comment
          if [ "${{ github.event_name }}" == "pull_request_review_comment" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            COMMENT_TYPE="review"
          else
            # For issue_comment, check if it's on a PR
            PR_NUMBER="${{ github.event.issue.number }}"
            COMMENT_TYPE="issue"
          fi
          
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "comment_type=${COMMENT_TYPE}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "comment_id=${{ github.event.comment.id }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.comment.user.login }}" >> $GITHUB_OUTPUT
          
      - name: Get PR details
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_DATA=$(gh pr view ${{ steps.context.outputs.pr_number }} \
            --repo ${{ steps.context.outputs.repo }} \
            --json title,url,body,headRefName,baseRefName,changedFiles,additions,deletions \
            2>/dev/null || echo '{}')
          
          if [ "$PR_DATA" != "{}" ]; then
            TITLE=$(echo "$PR_DATA" | jq -r '.title // "Unknown"')
            URL=$(echo "$PR_DATA" | jq -r '.url // ""')
            BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName // "unknown"')
            FILES=$(echo "$PR_DATA" | jq -r '.changedFiles // 0')
            ADDS=$(echo "$PR_DATA" | jq -r '.additions // 0')
            DELS=$(echo "$PR_DATA" | jq -r '.deletions // 0')
            
            echo "title=${TITLE}" >> $GITHUB_OUTPUT
            echo "url=${URL}" >> $GITHUB_OUTPUT
            echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
            echo "files=${FILES}" >> $GITHUB_OUTPUT
            echo "additions=${ADDS}" >> $GITHUB_OUTPUT
            echo "deletions=${DELS}" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram notification
        if: steps.pr.outputs.is_pr == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Escape special characters for Telegram MarkdownV2
          escape_md() {
            echo "$1" | sed 's/[_*\[\]()~`>#+=|{}.!-]/\\&/g'
          }
          
          COMMENT_BODY=$(cat << 'EOF'
          ${{ github.event.comment.body }}
          EOF
          )
          
          # Truncate comment if too long
          if [ ${#COMMENT_BODY} -gt 500 ]; then
            COMMENT_BODY="${COMMENT_BODY:0:500}..."
          fi
          
          # Build message (plain text to avoid escaping issues)
          MESSAGE="ðŸ¦‰ @seneca mention on GitHub

ðŸ“¦ Repo: ${{ steps.context.outputs.repo }}
ðŸ”€ PR #${{ steps.context.outputs.pr_number }}: ${{ steps.pr.outputs.title }}
ðŸŒ¿ Branch: ${{ steps.pr.outputs.branch }}
ðŸ“Š Changes: ${{ steps.pr.outputs.files }} files (+${{ steps.pr.outputs.additions }}/-${{ steps.pr.outputs.deletions }})

ðŸ’¬ From @${{ steps.context.outputs.author }}:
${COMMENT_BODY}

ðŸ”— ${{ steps.pr.outputs.url }}"

          # Send via Telegram API
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d disable_web_page_preview=true
